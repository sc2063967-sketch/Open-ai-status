<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Status Monitor</title>
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Syne:wght@700;800&display=swap" rel="stylesheet"/>
<style>
  :root {
    --bg:       #0a0a0f;
    --surface:  #111118;
    --border:   #1e1e2e;
    --accent:   #00ff88;
    --accent2:  #0088ff;
    --warn:     #ffaa00;
    --danger:   #ff4455;
    --text:     #e0e0f0;
    --muted:    #555570;
    --card:     #13131f;
  }

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'JetBrains Mono', monospace;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Grid background */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(rgba(0,255,136,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,255,136,0.03) 1px, transparent 1px);
    background-size: 40px 40px;
    pointer-events: none;
    z-index: 0;
  }

  .container {
    max-width: 960px;
    margin: 0 auto;
    padding: 2rem 1.5rem 4rem;
    position: relative;
    z-index: 1;
  }

  /* Header */
  header {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 3rem;
    border-bottom: 1px solid var(--border);
    padding-bottom: 1.5rem;
  }

  .logo-dot {
    width: 12px; height: 12px;
    background: var(--accent);
    border-radius: 50%;
    box-shadow: 0 0 12px var(--accent);
    animation: pulse 2s ease-in-out infinite;
    flex-shrink: 0;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; box-shadow: 0 0 12px var(--accent); }
    50%       { opacity: 0.4; box-shadow: 0 0 4px var(--accent); }
  }

  h1 {
    font-family: 'Syne', sans-serif;
    font-size: 1.6rem;
    font-weight: 800;
    letter-spacing: -0.02em;
    color: #fff;
  }

  h1 span { color: var(--accent); }

  .header-badge {
    margin-left: auto;
    font-size: 0.65rem;
    color: var(--muted);
    border: 1px solid var(--border);
    padding: 0.25rem 0.6rem;
    border-radius: 4px;
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }

  /* Section labels */
  .section-label {
    font-size: 0.65rem;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 0.75rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }
  .section-label::after {
    content: '';
    flex: 1;
    height: 1px;
    background: var(--border);
  }

  /* Feed config panel */
  .panel {
    background: var(--card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1.5rem;
    margin-bottom: 1.5rem;
  }

  /* Feed row */
  .feed-list { display: flex; flex-direction: column; gap: 0.6rem; }

  .feed-row {
    display: grid;
    grid-template-columns: 160px 1fr auto;
    gap: 0.5rem;
    align-items: center;
    animation: slideIn 0.2s ease;
  }

  @keyframes slideIn {
    from { opacity: 0; transform: translateY(-6px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  input[type="text"] {
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 5px;
    color: var(--text);
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.78rem;
    padding: 0.55rem 0.75rem;
    width: 100%;
    transition: border-color 0.2s;
    outline: none;
  }
  input[type="text"]:focus { border-color: var(--accent); }
  input[type="text"]::placeholder { color: var(--muted); }

  /* Buttons */
  .btn {
    font-family: 'JetBrains Mono', monospace;
    font-size: 0.75rem;
    font-weight: 600;
    letter-spacing: 0.05em;
    padding: 0.55rem 1.1rem;
    border-radius: 5px;
    border: none;
    cursor: pointer;
    transition: all 0.15s;
    white-space: nowrap;
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
  }

  .btn-ghost {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--muted);
  }
  .btn-ghost:hover { border-color: var(--accent); color: var(--accent); }

  .btn-add {
    background: transparent;
    border: 1px dashed var(--border);
    color: var(--muted);
    width: 100%;
    justify-content: center;
    padding: 0.6rem;
    margin-top: 0.5rem;
    border-radius: 5px;
    font-size: 0.72rem;
  }
  .btn-add:hover { border-color: var(--accent); color: var(--accent); background: rgba(0,255,136,0.04); }

  .btn-remove {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--muted);
    padding: 0.5rem 0.6rem;
    border-radius: 5px;
    font-size: 0.8rem;
    line-height: 1;
  }
  .btn-remove:hover { border-color: var(--danger); color: var(--danger); }

  .btn-run {
    background: var(--accent);
    color: #000;
    padding: 0.7rem 2rem;
    font-size: 0.8rem;
    font-weight: 700;
    border-radius: 5px;
    letter-spacing: 0.08em;
  }
  .btn-run:hover { background: #00ffaa; box-shadow: 0 0 20px rgba(0,255,136,0.3); }
  .btn-run:disabled { background: var(--border); color: var(--muted); cursor: not-allowed; box-shadow: none; }

  .btn-stop {
    background: transparent;
    border: 1px solid var(--danger);
    color: var(--danger);
    padding: 0.7rem 2rem;
    font-size: 0.8rem;
  }
  .btn-stop:hover { background: rgba(255,68,85,0.1); }

  .controls {
    display: flex;
    gap: 0.75rem;
    align-items: center;
    margin-top: 1.25rem;
  }

  .status-pill {
    margin-left: auto;
    font-size: 0.65rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    padding: 0.3rem 0.8rem;
    border-radius: 20px;
    background: var(--border);
    color: var(--muted);
    display: flex;
    align-items: center;
    gap: 0.4rem;
  }
  .status-pill.running {
    background: rgba(0,255,136,0.1);
    color: var(--accent);
    border: 1px solid rgba(0,255,136,0.3);
  }
  .status-pill .dot {
    width: 6px; height: 6px;
    border-radius: 50%;
    background: currentColor;
  }
  .status-pill.running .dot { animation: pulse 1.5s infinite; }

  /* Live feed / terminal */
  .terminal {
    background: #070710;
    border: 1px solid var(--border);
    border-radius: 8px;
    overflow: hidden;
    margin-bottom: 1.5rem;
  }

  .terminal-header {
    background: var(--surface);
    border-bottom: 1px solid var(--border);
    padding: 0.6rem 1rem;
    display: flex;
    align-items: center;
    gap: 0.5rem;
    font-size: 0.65rem;
    color: var(--muted);
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }

  .terminal-dots span {
    display: inline-block;
    width: 8px; height: 8px;
    border-radius: 50%;
    margin-right: 4px;
  }
  .terminal-dots .d1 { background: #ff5f57; }
  .terminal-dots .d2 { background: #febc2e; }
  .terminal-dots .d3 { background: #28c840; }

  #log-output {
    height: 160px;
    overflow-y: auto;
    padding: 0.75rem 1rem;
    font-size: 0.72rem;
    line-height: 1.7;
    color: var(--muted);
  }

  #log-output::-webkit-scrollbar { width: 4px; }
  #log-output::-webkit-scrollbar-track { background: transparent; }
  #log-output::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

  .log-line { display: flex; gap: 0.75rem; }
  .log-time { color: #333355; flex-shrink: 0; }
  .log-ok    { color: var(--accent); }
  .log-info  { color: var(--accent2); }
  .log-warn  { color: var(--warn); }
  .log-error { color: var(--danger); }

  /* Incidents */
  #incidents-list { display: flex; flex-direction: column; gap: 0.75rem; }

  .incident-card {
    background: var(--card);
    border: 1px solid var(--border);
    border-left: 3px solid var(--muted);
    border-radius: 0 8px 8px 0;
    padding: 1rem 1.25rem;
    animation: fadeUp 0.3s ease;
  }

  .incident-card.is-new {
    border-left-color: var(--accent);
    box-shadow: 0 0 20px rgba(0,255,136,0.08), inset 0 0 20px rgba(0,255,136,0.02);
    animation: newAlert 0.4s ease;
  }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(10px); }
    to   { opacity: 1; transform: translateY(0); }
  }

  @keyframes newAlert {
    0%   { box-shadow: 0 0 0px rgba(0,255,136,0); }
    50%  { box-shadow: 0 0 30px rgba(0,255,136,0.2); }
    100% { box-shadow: 0 0 20px rgba(0,255,136,0.08); }
  }

  .incident-meta {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    margin-bottom: 0.5rem;
    flex-wrap: wrap;
  }

  .incident-provider {
    font-size: 0.62rem;
    text-transform: uppercase;
    letter-spacing: 0.12em;
    color: var(--accent2);
    background: rgba(0,136,255,0.1);
    border: 1px solid rgba(0,136,255,0.2);
    padding: 0.15rem 0.5rem;
    border-radius: 3px;
  }

  .incident-product {
    font-size: 0.62rem;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    color: var(--accent);
    background: rgba(0,255,136,0.08);
    border: 1px solid rgba(0,255,136,0.15);
    padding: 0.15rem 0.5rem;
    border-radius: 3px;
  }

  .new-badge {
    font-size: 0.6rem;
    font-weight: 700;
    letter-spacing: 0.12em;
    color: #000;
    background: var(--accent);
    padding: 0.15rem 0.5rem;
    border-radius: 3px;
    animation: blink 1s ease 3;
  }

  @keyframes blink {
    0%, 100% { opacity: 1; }
    50%       { opacity: 0.3; }
  }

  .incident-ts {
    margin-left: auto;
    font-size: 0.65rem;
    color: var(--muted);
  }

  .incident-title {
    font-size: 0.88rem;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 0.4rem;
    line-height: 1.4;
  }

  .incident-detail {
    font-size: 0.72rem;
    color: var(--muted);
    line-height: 1.6;
    margin-bottom: 0.6rem;
  }

  .incident-link {
    font-size: 0.68rem;
    color: var(--accent2);
    text-decoration: none;
    letter-spacing: 0.05em;
  }
  .incident-link:hover { text-decoration: underline; }

  .empty-state {
    text-align: center;
    padding: 3rem 1rem;
    color: var(--muted);
    font-size: 0.75rem;
    line-height: 2;
    border: 1px dashed var(--border);
    border-radius: 8px;
  }

  .empty-state .big { font-size: 2rem; display: block; margin-bottom: 0.5rem; opacity: 0.3; }

  /* Notification toast */
  #toast {
    position: fixed;
    top: 1.5rem;
    right: 1.5rem;
    background: var(--card);
    border: 1px solid var(--accent);
    border-left: 4px solid var(--accent);
    border-radius: 8px;
    padding: 1rem 1.25rem;
    max-width: 340px;
    font-size: 0.75rem;
    box-shadow: 0 8px 32px rgba(0,0,0,0.5), 0 0 20px rgba(0,255,136,0.1);
    transform: translateX(120%);
    transition: transform 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    z-index: 999;
  }
  #toast.show { transform: translateX(0); }
  #toast-title { font-weight: 700; color: var(--accent); margin-bottom: 0.3rem; }
  #toast-body  { color: var(--muted); line-height: 1.5; }

  @media (max-width: 600px) {
    .feed-row { grid-template-columns: 1fr auto; }
    .feed-row input:first-of-type { grid-column: 1 / -1; }
  }
</style>
</head>
<body>
<div class="container">

  <header>
    <div class="logo-dot"></div>
    <h1>Status<span>Monitor</span></h1>
    <div class="header-badge">v2.0 Â· Live</div>
  </header>

  <!-- Feed Configuration -->
  <div class="section-label">Feed Configuration</div>
  <div class="panel">
    <div class="feed-list" id="feed-list"></div>
    <button class="btn btn-add" onclick="addFeedRow()">ï¼‹ Add another feed</button>

    <div class="controls">
      <button class="btn btn-run" id="btn-run" onclick="startMonitor()">â–¶ Run Monitor</button>
      <button class="btn btn-stop" id="btn-stop" onclick="stopMonitor()" style="display:none">â–  Stop</button>
      <div class="status-pill" id="status-pill">
        <span class="dot"></span> Idle
      </div>
    </div>
  </div>

  <!-- Live Log Terminal -->
  <div class="section-label">Live Log</div>
  <div class="terminal">
    <div class="terminal-header">
      <div class="terminal-dots">
        <span class="d1"></span><span class="d2"></span><span class="d3"></span>
      </div>
      console output
    </div>
    <div id="log-output">
      <div class="log-line">
        <span class="log-time">--:--:--</span>
        <span class="log-info">Add feeds above and click Run to start monitoring.</span>
      </div>
    </div>
  </div>

  <!-- Incidents -->
  <div class="section-label">Incidents</div>
  <div id="incidents-list">
    <div class="empty-state">
      <span class="big">ðŸ“¡</span>
      No incidents detected yet.<br/>
      Configure your feeds and click <strong>Run Monitor</strong>.
    </div>
  </div>

</div>

<!-- Toast notification -->
<div id="toast">
  <div id="toast-title"></div>
  <div id="toast-body"></div>
</div>

<script>
// â”€â”€ Default feeds â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DEFAULT_FEEDS = [
  { name: "OpenAI",    url: "https://status.openai.com/history.atom" },
];

let ws = null;
let isRunning = false;
let toastTimer = null;

// â”€â”€ Feed rows â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function addFeedRow(name = "", url = "") {
  const list = document.getElementById("feed-list");
  const row  = document.createElement("div");
  row.className = "feed-row";
  row.innerHTML = `
    <input type="text" placeholder="Provider name" value="${name}" class="feed-name"/>
    <input type="text" placeholder="https://status.example.com/history.atom" value="${url}" class="feed-url"/>
    <button class="btn btn-remove" onclick="removeFeedRow(this)" title="Remove">âœ•</button>
  `;
  list.appendChild(row);
}

function removeFeedRow(btn) {
  const rows = document.querySelectorAll(".feed-row");
  if (rows.length <= 1) { showToastMsg("Need at least 1 feed", "warning"); return; }
  btn.closest(".feed-row").remove();
}

function getFeeds() {
  return [...document.querySelectorAll(".feed-row")].map(row => ({
    name: row.querySelector(".feed-name").value.trim() || "Unknown",
    url:  row.querySelector(".feed-url").value.trim()
  })).filter(f => f.url);
}

// â”€â”€ Monitor control â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function startMonitor() {
  const feeds = getFeeds();
  if (!feeds.length) { showToastMsg("Add at least one feed URL first!", "warn"); return; }

  // Clear UI
  document.getElementById("log-output").innerHTML = "";
  document.getElementById("incidents-list").innerHTML = `
    <div class="empty-state"><span class="big">ðŸ“¡</span>Watching for incidents...</div>`;

  fetch("/api/start", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ feeds })
  }).then(r => r.json()).then(data => {
    if (data.error) { showToastMsg(data.error, "error"); return; }
    setRunning(true);
    connectWS();
  });
}

function stopMonitor() {
  fetch("/api/stop", { method: "POST" });
  setRunning(false);
  if (ws) { ws.close(); ws = null; }
}

function setRunning(running) {
  isRunning = running;
  document.getElementById("btn-run").style.display  = running ? "none" : "inline-flex";
  document.getElementById("btn-stop").style.display = running ? "inline-flex" : "none";
  const pill = document.getElementById("status-pill");
  pill.className = "status-pill" + (running ? " running" : "");
  pill.innerHTML = `<span class="dot"></span> ${running ? "Running" : "Idle"}`;
}

// â”€â”€ WebSocket â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function connectWS() {
  const proto = location.protocol === "https:" ? "wss" : "ws";
  ws = new WebSocket(`${proto}://${location.host}/ws`);

  ws.onmessage = (e) => {
    const msg = JSON.parse(e.data);
    if (msg.type === "log")      handleLog(msg.data);
    if (msg.type === "incident") handleIncident(msg.data);
  };

  ws.onclose = () => { if (isRunning) setTimeout(connectWS, 2000); };
}

// â”€â”€ Log handler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleLog({ msg, level }) {
  const out  = document.getElementById("log-output");
  const now  = new Date().toTimeString().slice(0, 8);
  const line = document.createElement("div");
  line.className = "log-line";
  line.innerHTML = `<span class="log-time">${now}</span><span class="log-${level}">${escHtml(msg)}</span>`;
  out.appendChild(line);
  out.scrollTop = out.scrollHeight;
}

// â”€â”€ Incident handler â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function handleIncident(inc) {
  const list = document.getElementById("incidents-list");

  // Remove empty state
  const empty = list.querySelector(".empty-state");
  if (empty) empty.remove();

  const card = document.createElement("div");
  card.className = "incident-card" + (inc.is_new ? " is-new" : "");
  card.innerHTML = `
    <div class="incident-meta">
      <span class="incident-provider">${escHtml(inc.provider)}</span>
      <span class="incident-product">${escHtml(inc.product)}</span>
      ${inc.is_new ? '<span class="new-badge">NEW</span>' : ''}
      <span class="incident-ts">${escHtml(inc.ts)}</span>
    </div>
    <div class="incident-title">${escHtml(inc.title)}</div>
    ${inc.detail ? `<div class="incident-detail">${escHtml(inc.detail)}</div>` : ""}
    <a class="incident-link" href="${escHtml(inc.link)}" target="_blank">â†’ View incident</a>
  `;

  // Prepend new incidents, append startup ones
  if (inc.is_new) {
    list.prepend(card);
    showToast(inc);
  } else {
    list.appendChild(card);
  }
}

// â”€â”€ Toast notification â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function showToast(inc) {
  const toast = document.getElementById("toast");
  document.getElementById("toast-title").textContent = "ðŸš¨ New Incident â€” " + inc.provider;
  document.getElementById("toast-body").textContent  = inc.title;
  toast.classList.add("show");
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => toast.classList.remove("show"), 6000);
}

function showToastMsg(msg, level) {
  const toast = document.getElementById("toast");
  toast.style.borderColor = level === "error" ? "var(--danger)" : "var(--warn)";
  document.getElementById("toast-title").textContent = level === "error" ? "Error" : "Notice";
  document.getElementById("toast-body").textContent  = msg;
  toast.classList.add("show");
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => toast.classList.remove("show"), 4000);
}

function escHtml(str) {
  return String(str)
    .replace(/&/g,"&amp;").replace(/</g,"&lt;")
    .replace(/>/g,"&gt;").replace(/"/g,"&quot;");
}

// â”€â”€ Init â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
DEFAULT_FEEDS.forEach(f => addFeedRow(f.name, f.url));
</script>
</body>
</html>
